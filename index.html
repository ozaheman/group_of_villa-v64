<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Master Plan Tool</title>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Your Stylesheet -->
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Global Batch Progress Overlay -->
    <div id="batch-progress-overlay" style="display: none;">
        <div class="progress-container-global">
            <h3 id="batch-progress-title">Generating Layouts...</h3>
            <div class="progress-bar-global">
                <div id="batch-progress-fill" class="progress-fill-global"></div>
            </div>
            <p id="batch-progress-status" style="font-size: 11px; margin-top: 5px; color: #666;">Step 0 of 0</p>
        </div>
    </div>
    <div id="controls">
        <div class="control-group">
            <h3>Project Management</h3>
            <div style="display: flex; gap: 5px; margin-bottom: 8px;">
                <button id="save-project-zip" class="primary" style="flex: 1; margin:0;">üíæ Export ZIP</button>
                <label for="zip-loader" class="button secondary"
                    style="flex: 1; text-align: center; margin:0; cursor: pointer;">üìÇ Import ZIP</label>
                <input type="file" id="zip-loader" style="display:none;" accept=".zip">
            </div>
            <label for="bg-loader" class="button success" style="width: 100%; text-align: center; cursor: pointer;">üìÑ
                Import Affection Plan (PDF/IMG)</label>
            <input type="file" id="bg-loader" style="display:none;" accept="image/jpeg, image/png, application/pdf">
        </div>

        <div class="control-group">
            <h3>1. Site Setup</h3>
            <button id="calibrate-scale" class="secondary">Calibrate Scale</button>
            <div class="control-item"><span>Scale:</span><span id="scale-info" class="info-value">1px = 1.00m</span>
            </div>
            <div class="control-item"><label for="gfa">Total GFA (m¬≤):</label> <input type="number" id="gfa"
                    value="50000"></div>
            <div class="control-item"><label for="load">Conn. Load (kW):</label> <input type="number" id="load"
                    value="1500"></div>
        </div>

        <div class="control-group">
            <h3>2. Master Polygon</h3>
            <button id="start-draw">Start Drawing</button>
            <button id="finish-draw" class="secondary" disabled>Finish Drawing</button>
            <button id="edit-poly" class="secondary" disabled>Edit Polygon</button>
            <button id="remove-vertex" class="danger" disabled>Remove Selected Vertex</button>
            <div class="control-item"><label for="ortho-mode">Ortho</label> <input type="checkbox" id="ortho-mode">
            </div>
            <div class="control-item"><label for="osnap-mode">OSNAP</label> <input type="checkbox" id="osnap-mode"
                    checked></div>
        </div>

        <div class="control-group">
            <h3>3. Layout Parameters (meters)</h3>
            <div class="control-item"><label for="green-area">Green (%): <span
                        id="green-area-val">20</span>%</label><input type="range" id="green-area" min="0" max="50"
                    value="20"></div>
            <div class="control-item"><label for="amenities-area">Amenities (%): <span
                        id="amenities-area-val">10</span>%</label><input type="range" id="amenities-area" min="0"
                    max="50" value="10"></div>
            <div class="control-item"><label for="road-width">Road Width:</label> <input type="number" id="road-width"
                    value="7" disabled></div>
            <div class="control-item"><label for="pavement-width">Pavement:</label> <input type="number"
                    id="pavement-width" value="5" disabled></div>
            <div class="control-item"><label for="plot-depth">Plot Depth:</label> <input type="number" id="plot-depth"
                    value="30"></div>
            <div class="control-item"><label for="plot-width">Plot Width:</label> <input type="number" id="plot-width"
                    value="15"></div>
            <hr>
            <div class="control-item"><label for="pavement-width-left">Left Pavement:</label> <input type="number"
                    id="pavement-width-left" value="2.5"></div>
            <div class="control-item"><label for="pavement-width-right">Right Pavement:</label> <input type="number"
                    id="pavement-width-right" value="2.5"></div>
            <div class="control-item"><label for="num-lanes">No. of Lanes:</label> <input type="number" id="num-lanes"
                    value="2" min="1"></div>
            <div class="control-item"><label for="lane-width">Lane Width:</label> <input type="number" id="lane-width"
                    value="3.5"></div>
            <div class="control-item"><label for="turning-radius">Turning Radius (m):</label> <input type="number"
                    id="turning-radius" value="15" min="10" max="20" step="0.5"></div>
            <hr>
            <div class="control-item">
                <button id="add-entry" class="secondary" style="width: 48%; display: inline-block;">üìç Add
                    Entry</button>
                <button id="add-exit" class="secondary" style="width: 48%; display: inline-block; margin-left: 2%;">üö™
                    Add Exit</button>
            </div>
            <div class="control-item" style="font-size: 10px; color: #666;">
                <span id="entry-exit-info">Entry: None | Exit: None</span>
            </div>
            <hr>
            <h4>Urban Planning Standards</h4>
            <div class="control-item"><label for="road-type">Road Type:</label>
                <select id="road-type">
                    <option value="local">Local Street (12-18m)</option>
                    <option value="collector">Collector (20-30m)</option>
                    <option value="access" selected>Access Lane (6-9m)</option>
                </select>
            </div>
            <div class="control-item"><label for="density-type">Target Density:</label>
                <select id="density-type">
                    <option value="lowDensity">Low Density (300m¬≤+)</option>
                    <option value="mediumDensity" selected>Med. Density (150m¬≤+)</option>
                    <option value="highDensity">High Density (75m¬≤+)</option>
                </select>
            </div>
            <div class="control-item"><label for="plot-prototype">Building Type:</label>
                <select id="plot-prototype">
                    <option value="mixed" selected>Mixed Distribution</option>
                    <option value="Compact">Compact Box</option>
                    <option value="L-Shape">L-Shaped Villa</option>
                    <option value="Courtyard">Courtyard Villa</option>
                    <option value="U-Shape">U-Shaped Villa</option>
                    <option value="Twin">Twin Unit</option>
                </select>
            </div>
            <div class="control-item">
                <label>Plot Mix (Affordable/Mid/Luxury):</label>
                <span id="mix-info" style="font-size:10px">25/45/30</span>
            </div>
            <hr>
            <h4>Planning Method for Generative Design</h4>
            <div class="control-item" style="flex-direction: column; align-items: flex-start;">
                <label style="display: flex; align-items: center; margin: 3px 0;">
                    <input type="checkbox" id="plan-grid" value="grid" style="width: auto; margin-right: 8px;">
                    <span style="font-size: 11px;">Grid Layout (Orthogonal)</span>
                </label>
                <label style="display: flex; align-items: center; margin: 3px 0;">
                    <input type="checkbox" id="plan-culdeSac" value="culdesac" style="width: auto; margin-right: 8px;">
                    <span style="font-size: 11px;">Cul-de-Sac (Finger)</span>
                </label>
                <label style="display: flex; align-items: center; margin: 3px 0;">
                    <input type="checkbox" id="plan-cluster" value="cluster" style="width: auto; margin-right: 8px;">
                    <span style="font-size: 11px;">Cluster (Courtyard)</span>
                </label>
                <label style="display: flex; align-items: center; margin: 3px 0;">
                    <input type="checkbox" id="plan-loop" value="loop" checked style="width: auto; margin-right: 8px;">
                    <span style="font-size: 11px;">Loop Layout</span>
                </label>
                <label style="display: flex; align-items: center; margin: 3px 0;">
                    <input type="checkbox" id="plan-linear" value="linear" style="width: auto; margin-right: 8px;">
                    <span style="font-size: 11px;">Linear (Single-Loaded)</span>
                </label>
                <label style="display: flex; align-items: center; margin: 3px 0;">
                    <input type="checkbox" id="plan-organic" value="organic" style="width: auto; margin-right: 8px;">
                    <span style="font-size: 11px;">Organic (Contour)</span>
                </label>
                <label style="display: flex; align-items: center; margin: 3px 0;">
                    <input type="checkbox" id="plan-radburn" value="radburn" style="width: auto; margin-right: 8px;">
                    <span style="font-size: 11px;">Radburn (Pedestrian-Centric)</span>
                </label>
            </div>
        </div>

        <div class="control-group" id="prototype-panel">
            <h3>3a. Building Prototypes</h3>
            <div class="control-item">
                <label for="override-mode">Manual Override:</label>
                <input type="checkbox" id="override-mode">
            </div>
            <div class="control-item">
                <label>Remaining:</label>
                <span id="remaining-percentage" style="color: #ff9800; font-weight: bold;">100.0%</span>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0 8px 0;">
                <h4 style="font-size: 12px; margin: 0; color: #0056b3;">Villas</h4>
                <button id="add-villa-proto" class="secondary"
                    style="width: auto; padding: 2px 8px; margin: 0; font-size: 10px;">+ Add Villa</button>
            </div>
            <div id="villas-container" class="prototype-group">
                <!-- Dynamic Content -->
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0 8px 0;">
                <h4 style="font-size: 12px; margin: 0; color: #0056b3;">Townhouses</h4>
                <button id="add-townhouse-proto" class="secondary"
                    style="width: auto; padding: 2px 8px; margin: 0; font-size: 10px;">+ Add Townhouse</button>
            </div>
            <div id="townhouses-container" class="prototype-group">
                <!-- Dynamic Content -->
            </div>

            <div style="margin-top: 10px;">
                <button id="reset-prototypes" class="secondary" style="width: 31%; margin-right: 1%;">Reset</button>
                <button id="normalize-mix" class="secondary" style="width: 31%; margin-right: 1%;">Normalize</button>
                <button id="show-proto-stats" class="secondary" style="width: 31%;">Stats</button>
            </div>
            <div id="proto-stats" class="proto-stats-panel"
                style="display:none; margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 11px;">
                <h4 style="margin-top: 0;">Prototype Statistics</h4>
                <div id="proto-stats-content"></div>
            </div>
        </div>

        <!-- Parking & Public Realm -->
        <div class="control-group">
            <div class="group-title">Parking & Visitor Control</div>

            <div class="control-item">
                <label for="show-parking" style="font-size: 11px;">Show Parking Boxes</label>
                <input type="checkbox" id="show-parking" style="width: auto;">
            </div>

            <div class="control-item">
                <label for="enable-parallel-parking" style="font-size: 11px;">Parallel Parking (Paver 3)</label>
                <input type="checkbox" id="enable-parallel-parking" style="width: auto;">
            </div>

            <div class="control-item">
                <label for="parking-interval" style="font-size: 11px;">Interval (m)</label>
                <input type="number" id="parking-interval" value="15" min="5" step="5">
            </div>

            <hr style="margin: 8px 0; opacity: 0.3;">

            <div class="control-item" style="flex-direction: column; align-items: flex-start;">
                <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                    <label style="font-size: 11px;">Visitor Parking Goal</label>
                    <span id="visitor-parking-val" style="font-size: 11px; font-weight: bold; color: #0056b3;">0</span>
                </div>
                <div style="display: flex; gap: 8px; width: 100%; align-items: center;">
                    <input type="range" id="visitor-parking-slider" min="0" max="100" value="0" disabled
                        style="flex: 1;">
                    <input type="checkbox" id="visitor-manual-override" title="Manual Override" style="width: auto;">
                </div>
            </div>
        </div>

        <div class="control-group">
            <h3>4. Actions & Tools</h3>
            <button id="draw-road" class="secondary">Draw Road Centerline</button>
            <button id="finish-road" class="success" style="display: none;">Finish Road Drawing</button>
            <!-- Manual Road Tools -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 5px;">
                <button id="manual-fillet-btn" class="secondary" style="font-size: 11px;">Fillet (R)</button>
                <input type="number" id="manual-fillet-val" value="15" style="width: 100%;" placeholder="R">
                <button id="manual-gen-road-btn" class="secondary" style="font-size: 11px;">Gen Road</button>
                <button id="manual-gen-pave-btn" class="secondary" style="font-size: 11px;">Gen Pave</button>
                <button id="manual-connect-btn" class="secondary" style="font-size: 11px;">Connect E/E</button>
                <button id="manual-green-btn" class="secondary" style="font-size: 11px;">Draw Green</button>
                <button id="manual-green-balance-btn" class="secondary" style="font-size: 11px;">Green Balance</button>
                <button id="manual-gen-plots-btn" class="secondary" style="font-size: 11px;">Gen Plots (Inner)</button>
                <button id="manual-gen-plots-outer-btn" class="secondary" style="font-size: 11px;">Gen Plots
                    (Outer)</button>
                <button id="manual-bifurcate-btn" class="secondary" style="font-size: 11px;">Bifurcate Road</button>
                <button id="manual-recalc-btn" class="secondary" style="font-size: 11px;">Recalc All</button>
            </div>
            <button id="restart-btn" class="danger" style="margin-top: 5px; width: 100%;">Restart / Clear</button>
            <button id="delete-selected-btn" class="danger" style="margin-top: 5px; width: 100%;">Delete Selected
                Polygon</button>
            <button id="measure-tool" style="margin-top: 5px;">Measure Tool</button>
            <hr>
            <button id="edit-road-centerline" class="secondary">‚úèÔ∏è Edit Road Centerline</button>
            <button id="edit-green-area" class="secondary">‚úèÔ∏è Edit Green Area</button>
            <hr>
            <button id="gen-layouts" class="success primary" disabled>Generate Layout Solutions</button>
            <hr>
            <div id="step-wizard">
                <h4>Step-by-Step Wizard</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px;">
                    <button id="step-1" class="secondary">1. Outer Plots</button>
                    <button id="step-2" class="secondary">2. Outer Pave</button>
                    <button id="step-3" class="secondary">3. Road Ring</button>
                    <button id="step-4" class="secondary">4. Fillet & Gen Rd</button>
                    <button id="step-5" class="secondary">5. Inner Plots</button>
                    <button id="step-6" class="secondary">6. Analyze</button>
                    <button id="step-7" class="secondary">7. Bifurcate</button>
                    <button id="step-8" class="secondary">8. Show Rd</button>
                    <button id="step-9" class="secondary">9. Rd + Pave</button>
                    <button id="step-10" class="secondary">10. Green Check</button>
                    <button id="step-11" class="secondary">11. Side A</button>
                    <button id="step-12" class="secondary">12. Side B</button>
                    <button id="step-13" class="secondary">13. Entry Rd</button>
                    <button id="step-14" class="secondary">14. Exit Rd</button>
                    <button id="step-15" class="secondary">15. Project Report</button>
                    <button id="step-16" class="secondary">16. Detail Report</button>
                </div>
                <button id="step-finalize" class="primary" style="width: 100%; margin-top: 8px;">Finalize Grid
                    Analysis</button>
                <button id="export-dxf-btn" class="secondary" style="width: 100%; margin-top: 8px;">üíæ Export DXF
                    (CAD)</button>
            </div>
            <hr>
            <div style="margin-bottom: 8px;">
                <label><input type="checkbox" id="toggle-labels" checked> Show Plot Labels</label>
            </div>
            <button id="reset-view" class="secondary">Reset View</button>
            <button id="clear-canvas" class="danger">Clear All</button>
        </div>

        <div class="control-group">
            <h3>5. Market Analysis (UAE)</h3>
            <div class="control-item">
                <label for="search-area">Search Area/City:</label>
                <input type="text" id="search-area" value="Dubai Hills Estate" placeholder="e.g. Dubai Hills"
                    list="dubai-locations-list">
                <datalist id="dubai-locations-list"></datalist>
            </div>
            <button id="search-prices-btn" class="secondary" style="margin-bottom: 10px; width: 100%;">üîç Search
                Listings (Bayut/PF)</button>
            <div class="control-item">
                <label for="price-per-sqft">Price (AED/sq.ft):</label>
                <input type="number" id="price-per-sqft" value="350" min="0" step="10">
            </div>
        </div>

        <div class="control-group" id="solutions-panel" style="display:none;">
            <h3>5. Generative Solutions</h3>
            <div class="control-item">
                <label style="display: flex; align-items: center; margin: 5px 0; cursor: pointer;">
                    <input type="checkbox" id="infra-only-view" style="width: auto; margin-right: 8px;">
                    <span style="font-size: 11px; font-weight: bold;">Preview Road Network Only</span>
                </label>
            </div>
            <div id="infra-metrics" style="font-size: 10px; color: #666; margin-bottom: 5px; display: none;">
                Road Length: <span id="infra-length">0</span>m | Area: <span id="infra-area">0</span>m¬≤
            </div>

            <!-- Land Use Legend -->
            <div class="legend-group">
                <div class="legend-item">
                    <div class="legend-color" style="background:#2196F3;"></div>Plots
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background:#4CAF50;"></div>Green
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background:#FFC107;"></div>Amenity
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background:#9E9E9E;"></div>Roads
                </div>
            </div>

            <div id="solutions-gallery" class="gallery"></div>
        </div>

        <div class="control-group" id="info-panel">
            <h3>Calculated Areas</h3>
            <div class="control-item"><span>Total Site Area:</span><span id="total-area" class="info-value">0.00
                    m¬≤</span></div>
            <div class="control-item"><span>Plot Area:</span><span id="plot-area-calc" class="info-value">0.00
                    m¬≤</span>
            </div>
            <div class="control-item"><span>No. of Plots:</span><span id="plot-count" class="info-value">0</span>
            </div>
            <div class="control-item"><span>Green Area %:</span><span id="green-area-percent" class="info-value">0.00
                    %</span></div>
            <div class="control-item"><span>Amenities Area %:</span><span id="amenities-area-percent"
                    class="info-value">0.00
                    %</span></div>
            <div class="control-item"><span>Infrastructure Area:</span><span id="infra-area-calc"
                    class="info-value">0.00 m¬≤</span></div>
        </div>

        <div class="control-group" id="report-panel" style="display:none;">
            <h3>üìä Project Report</h3>
            <div id="report-content" style="font-size: 11px; max-height: 400px; overflow-y: auto;">
                <!-- Report content will be dynamically generated -->
            </div>
            <hr style="margin: 10px 0;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button id="export-pdf" class="primary" style="font-size: 11px;">üìÑ Export PDF</button>
                <button id="export-csv" class="secondary" style="font-size: 11px;">üìä Export CSV</button>
                <button id="export-excel" class="secondary" style="font-size: 11px;">üìà Export Excel</button>
                <button id="show-report" class="success" style="font-size: 11px;">üîÑ Refresh</button>
            </div>
            <button id="detailed-plot-report" class="primary" style="width: 100%; margin-top: 8px; font-size: 11px;">üìã
                Plot Details Report</button>
        </div>
    </div>

    <div id="canvas-container"><canvas id="c" width="1000" height="800"></canvas></div>

    <script src="js/main.js" type="module"></script>
</body>

</html>